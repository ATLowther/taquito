(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{110:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return h}));var a=n(0),r=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=r.a.createContext({}),p=function(e){var t=r.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):c(c({},t),e)),n},u=function(e){var t=p(e.components);return r.a.createElement(l.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},d=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,i=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),u=p(n),d=a,h=u["".concat(i,".").concat(d)]||u[d]||m[d]||o;return n?r.a.createElement(h,c(c({ref:t},l),{},{components:n})):r.a.createElement(h,c({ref:t},l))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=d;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c.mdxType="string"==typeof e?e:a,i[1]=c;for(var l=2;l<o;l++)i[l]=n[l];return r.a.createElement.apply(null,i)}return r.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},86:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return c})),n.d(t,"toc",(function(){return s})),n.d(t,"default",(function(){return p}));var a=n(3),r=n(7),o=(n(0),n(110)),i={title:"Drain an account",author:"Roxane Letourneau"},c={unversionedId:"drain_account",id:"drain_account",isDocsHomePage:!1,title:"Drain an account",description:"In this section, we show how to transfer all tokens from one account (implicit or originated) to another so that the source account balance is zero.",source:"@site/../docs/drain_account.md",slug:"/drain_account",permalink:"/docs/drain_account",version:"current",sidebar:"docs",previous:{title:"Storage with/without annotations",permalink:"/docs/storage_annotations"},next:{title:"Ledger",permalink:"/docs/ledger_integration_test"}},s=[{value:"Draining implicit accounts (tz1, tz2, tz3)",id:"draining-implicit-accounts-tz1-tz2-tz3",children:[]},{value:"Draining originated accounts (KT1)",id:"draining-originated-accounts-kt1",children:[]}],l={toc:s};function p(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},l,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"In this section, we show how to transfer all tokens from one account (implicit or originated) to another so that the source account balance is zero."),Object(o.b)("h2",{id:"draining-implicit-accounts-tz1-tz2-tz3"},"Draining implicit accounts (tz1, tz2, tz3)"),Object(o.b)("p",null,'We want to "empty" an implicit account by sending all of its tokens to another account. It can be tricky to empty a tezos account completely because the gas fee must be subtracted from the account balance.'),Object(o.b)("p",null,"To do so, we first need to estimate the fees related to this operation. The ",Object(o.b)("inlineCode",{parentName:"p"},"estimate")," property of the ",Object(o.b)("inlineCode",{parentName:"p"},"TezosToolkit")," provides access to operation estimation utilities. Calling the ",Object(o.b)("inlineCode",{parentName:"p"},"transfer")," method will return an instance of the ",Object(o.b)("inlineCode",{parentName:"p"},"Estimate")," class and its ",Object(o.b)("inlineCode",{parentName:"p"},"suggestedFeeMutez")," property will allow us to know the fee associated with the operation."),Object(o.b)("p",null,"Once we know the associated fees, we can calculate the maximum amount that needs to be sent to drain the account by subtracting these fees from the account balance."),Object(o.b)("p",null,"Finally, we can do the transfer operation and use the maximum amount we just calculated as the ",Object(o.b)("inlineCode",{parentName:"p"},"amount")," parameter of the ",Object(o.b)("inlineCode",{parentName:"p"},"transfer")," function."),Object(o.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(o.b)("div",{parentName:"div",className:"admonition-heading"},Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",{parentName:"h5",className:"admonition-icon"},Object(o.b)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},Object(o.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),Object(o.b)("div",{parentName:"div",className:"admonition-content"},Object(o.b)("p",{parentName:"div"},"In the following example, the account we want to empty is not yet revealed. We need to keep in mind that there are fees related to a reveal operation. This is why we are subtracting 1420 mutez from the balance as it will be used as reveal fees."),Object(o.b)("p",{parentName:"div"},Object(o.b)("strong",{parentName:"p"},"If the account to drain has already been revealed, you must not subtract this amount (1420 mutez) from the balance.")))),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js",metastring:"live noInline",live:!0,noInline:!0},"// const Tezos = new TezosToolkit('https://api.tez.ie/rpc/delphinet');\n\nTezos.signer\n  .publicKeyHash()\n  .then((address) => {\n    Tezos.tz.getBalance(address).then((balance) => {\n      println(\n        `The account we want to drain is ${address}.\\nIts initial balance is ${\n          balance.toNumber() / 1000000\n        } \ua729.`\n      );\n      Tezos.estimate\n        .transfer({\n          to: 'tz1PgQt52JMirBUhhkq1eanX8hVd1Fsg71Lr',\n          amount: balance.toNumber() - 1420,\n          mutez: true,\n        })\n        .then((estimate) => {\n          //Subtract 1420 mutez for fees related to the reveal operation\n          const maxAmount = balance.minus(estimate.suggestedFeeMutez).toNumber() - 1420;\n          println(\n            `The estimated fees related to the emptying operation are ${\n              estimate.suggestedFeeMutez\n            } mutez.\\nConsidering the fees, the amount we need to send to empty the account is ${\n              maxAmount / 1000000\n            } \ua729.`\n          );\n          return Tezos.contract.transfer({\n            to: 'tz1PgQt52JMirBUhhkq1eanX8hVd1Fsg71Lr',\n            mutez: true,\n            amount: maxAmount,\n            fee: estimate.suggestedFeeMutez,\n            gasLimit: estimate.gasLimit,\n            storageLimit: 0,\n          });\n        })\n        .then((op) => {\n          println(`Waiting for confirmation of the draining operation...`);\n          return op.confirmation(1).then(() => op.hash);\n        })\n        .then((hash) => {\n          println(`The account has been emptied.`);\n          return Tezos.tz.getBalance(address);\n        })\n        .then((finalBalance) => {\n          println(`The balance is now ${finalBalance.toNumber() / 1000000} \ua729.`);\n        });\n    });\n  })\n  .catch((error) => println(`Error: ${JSON.stringify(error, null, 2)}`));\n")),Object(o.b)("h2",{id:"draining-originated-accounts-kt1"},"Draining originated accounts (KT1)"),Object(o.b)("p",null,"In the following example, we first originate a contract with a starting balance of 8 \ua729. Then, we transfer all of its tokens to an implicit account."),Object(o.b)("p",null,"The contract we originate is a ",Object(o.b)("inlineCode",{parentName:"p"},"manager contract"),". It has a ",Object(o.b)("inlineCode",{parentName:"p"},"do")," method taking a lambda function as a parameter. We call the smart contract by passing a function called ",Object(o.b)("inlineCode",{parentName:"p"},"transferImplicit")," to its ",Object(o.b)("inlineCode",{parentName:"p"},"do")," method in order to transfer its tokens to the implicit address. More information on transfers involving originated KT1 addresses can be found ",Object(o.b)("a",{parentName:"p",href:"https://tezostaquito.io/docs/making_transfers#transfers-involving-originated-kt1-addresses"},"here"),"."),Object(o.b)("p",null,"In the example, we estimate the transfer operation before doing it. When draining the account, the associated fees will be deducted from the manager's address. Thus, for the operation to be successful, the manager's address for that account must contain funds to cover the gas."),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js",metastring:"live noInline",live:!0,noInline:!0},"// const Tezos = new TezosToolkit('https://api.tez.ie/rpc/delphinet');\n\nfunction transferImplicit(key, mutez) {\n  return [\n    { prim: 'DROP' },\n    { prim: 'NIL', args: [{ prim: 'operation' }] },\n    {\n      prim: 'PUSH',\n      args: [{ prim: 'key_hash' }, { string: key }],\n    },\n    { prim: 'IMPLICIT_ACCOUNT' },\n    {\n      prim: 'PUSH',\n      args: [{ prim: 'mutez' }, { int: `${mutez}` }],\n    },\n    { prim: 'UNIT' },\n    { prim: 'TRANSFER_TOKENS' },\n    { prim: 'CONS' },\n  ];\n}\n\nTezos.signer\n  .publicKeyHash()\n  .then((address) => {\n    Tezos.contract\n      .originate({\n        balance: '8',\n        code: managerCode,\n        init: { string: address },\n      })\n      .then((contractOrigination) => {\n        println(\n          `Waiting for confirmation of origination for ${contractOrigination.contractAddress}...`\n        );\n        return contractOrigination.contract();\n      })\n      .then((contract) => {\n        println(`Origination completed.`);\n        Tezos.tz.getBalance(contract.address).then((balance) => {\n          println(`The balance of the contract is ${balance.toNumber() / 1000000} \ua729.`);\n          const estimateOp = contract.methods\n            .do(transferImplicit('tz1PgQt52JMirBUhhkq1eanX8hVd1Fsg71Lr', balance.toNumber()))\n            .toTransferParams({});\n          println(`Waiting for the estimation of the smart contract call...`);\n          Tezos.estimate\n            .transfer(estimateOp)\n            .then((estimate) => {\n              //Will be deducted from manager's address\n              println(\n                `The estimated fees related to the emptying operation are ${estimate.suggestedFeeMutez} mutez.`\n              );\n              return contract.methods\n                .do(transferImplicit('tz1PgQt52JMirBUhhkq1eanX8hVd1Fsg71Lr', balance.toNumber()))\n                .send({ amount: 0 });\n            })\n            .then((operation) => {\n              println(`Waiting for confirmation of the draining operation...`);\n              return operation.confirmation(1).then(() => operation.hash);\n            })\n            .then((hash) => {\n              println(`The account has been emptied.`);\n              return Tezos.tz.getBalance(contract.address);\n            })\n            .then((finalBalance) => {\n              println(`The balance is now ${finalBalance.toNumber() / 1000000} \ua729.`);\n            });\n        });\n      });\n  })\n  .catch((error) => println(`Error: ${JSON.stringify(error, null, 2)}`));\n")))}p.isMDXComponent=!0}}]);